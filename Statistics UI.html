<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FoodIQ ‚Äî Canteen Analytics</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary: #ff7a20;
      --primary-hover: #e56000;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --radius: 12px;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg);
      color: var(--text-main);
      margin: 0;
      padding: 0;
      line-height: 1.5;
    }

    /* Layout Structure */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 24px;
    }

    /* Header */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
      background: var(--card-bg);
      padding: 16px 24px;
      border-radius: 16px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--border);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      background: var(--primary);
      color: white;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
    }

    .brand-text h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 20px;
      margin: 0;
      font-weight: 700;
      color: var(--text-main);
      line-height: 1.2;
    }

    .brand-text span {
      font-size: 13px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    /* KPI Grid */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kpi-card {
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .kpi-label { font-size: 13px; color: var(--text-muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .kpi-value { font-size: 28px; font-weight: 700; color: var(--text-main); margin-top: 8px; font-family: 'Poppins', sans-serif; }

    /* Main Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title { font-family: 'Poppins', sans-serif; font-size: 16px; font-weight: 600; color: var(--text-main); }
    .card-subtitle { font-size: 13px; color: var(--text-muted); }

    /* Controls & Inputs */
    input[type="date"], input[type="number"] {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 14px;
      color: var(--text-main);
      background: #f9fafb;
      transition: all 0.2s;
    }
    input:focus { border-color: var(--primary); background: #fff; }

    button.btn {
      padding: 9px 16px;
      border-radius: 8px;
      border: 1px solid transparent;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    /* Primary: Solid Orange */
    .btn-primary { 
      background: var(--primary); 
      color: white; 
      box-shadow: 0 2px 4px rgba(255,122,32,0.2); 
    }
    .btn-primary:hover { 
      background: var(--primary-hover); 
      transform: translateY(-1px); 
    }
    
    /* Outline Primary: White BG, Orange Text/Border */
    .btn-outline-primary {
      background: white;
      border-color: var(--primary);
      color: var(--primary);
    }
    .btn-outline-primary:hover {
      background: #fff7ed; /* Light orange tint */
      color: var(--primary-hover);
      border-color: var(--primary-hover);
    }
    
    .btn-secondary { background: white; border-color: var(--border); color: var(--text-main); }
    .btn-secondary:hover { background: #f9fafb; border-color: #d1d5db; }
    
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }

    /* Tables & Lists */
    .table-container {
      overflow-y: auto;
      max-height: 400px;
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .data-row {
      display: flex;
      justify-content: space-between;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      background: white;
      transition: background 0.15s;
      cursor: pointer;
    }
    .data-row:last-child { border-bottom: none; }
    .data-row:hover { background: #fff7ed; }
    .data-date { font-weight: 600; font-size: 14px; }
    .data-meta { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
    .data-value { font-weight: 700; font-size: 15px; color: var(--primary); text-align: right; }
    .data-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; }

    /* Helpers */
    .controls-row { display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .helper-text { font-size: 13px; color: var(--text-muted); line-height: 1.4; }
    .mt-4 { margin-top: 16px; }

    /* Responsive */
    @media (max-width: 1024px) {
      .dashboard-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

  <div class="container">
    
    <header class="header">
      <div class="brand">
        <div class="brand-icon">üçΩ</div>
        <div class="brand-text">
          <h1>FoodIQ</h1>
          <span>Canteen Analytics Dashboard</span>
        </div>
      </div>
      <div class="header-actions">
        <span class="helper-text" id="yearBox">2023</span>
        <button class="btn btn-secondary" id="refreshBtn">
          <span style="margin-right:4px">‚Üª</span> Refresh Data
        </button>
      </div>
    </header>

    <div class="kpi-grid" id="kpiArea">
      <div class="kpi-card">
        <div class="kpi-label">Total Prepared</div>
        <div class="kpi-value" id="prepared">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Consumed</div>
        <div class="kpi-value" id="consumed">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Surplus</div>
        <div class="kpi-value" id="surplus" style="color: var(--primary);">--</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Avg. Consumption Rate</div>
        <div class="kpi-value" id="consrate">--%</div>
      </div>
    </div>

    <div class="dashboard-grid">
      
      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Daily Surplus Trend</div>
              <div class="card-subtitle">Last 60 days activity</div>
            </div>
          </div>
          <div style="position: relative; height: 260px; width: 100%;">
            <canvas id="dailyChart"></canvas>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Top Wasted Dishes</div>
              <div class="card-subtitle">Highest percentage of waste by item</div>
            </div>
          </div>
          <div style="position: relative; height: 220px; width: 100%;">
            <canvas id="dishChart"></canvas>
          </div>
        </div>
      </div>

      <div style="display: flex; flex-direction: column; gap: 24px;">
        
        <div class="card" style="height: auto;">
          <div class="card-header">
            <div class="card-title">Analysis Tools</div>
          </div>

          <div style="margin-bottom: 24px;">
            <div class="kpi-label" style="margin-bottom: 8px;">Threshold Check</div>
            <div class="controls-row">
              <input id="thresholdDate" type="date" style="flex:1" />
              <input id="thresholdQty" type="number" placeholder="Qty" style="width: 80px;" />
              <button class="btn btn-primary" id="checkBtn">Check</button>
            </div>
            <div id="thresholdResult" class="helper-text" style="background:#f9fafb; padding:10px; border-radius:8px; border:1px dashed var(--border);">
              Select a date and quantity to find high-waste items.
            </div>
          </div>

          <div>
            <div class="kpi-label" style="margin-bottom: 8px;">Quick Actions</div>
            <div class="controls-row">
              <button class="btn btn-primary" id="predBtn" style="flex:1;">Show Predictions</button>
              <button class="btn btn-outline-primary" id="exportBtn" style="flex:1;">Export CSV</button>
            </div>
          </div>
        </div>

        <div class="card" style="flex: 1; min-height: 400px;">
          <div class="card-header">
            <div>
              <div class="card-title">Detailed Logs</div>
              <div class="card-subtitle">Click row to inspect details</div>
            </div>
          </div>
          <div id="tableWrap" class="table-container">
            <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading data...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // --- Configuration ---
    // Change this if your API is on a different port/host
    const API = `${window.location.protocol}//${window.location.hostname}:5000/api`;
    
    // --- Chart Defaults ---
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#6b7280';
    
    document.getElementById("yearBox").innerText = new Date().getFullYear();

    // --- Helper: API Fetcher ---
    async function apiGet(path, params={}) {
      const url = `${API}${path}`;
      const res = await axios.get(url, { params });
      return res.data;
    }

    let dailyChartInstance, dishChartInstance;

    // --- Renderer: Top KPI Cards ---
    function renderOverview(o){
      if(!o){ 
        console.error("No overview data");
        return; 
      }
      const animateValue = (id, val, suffix='') => {
        document.getElementById(id).innerText = (val ?? "‚Äî") + suffix;
      };
      
      animateValue("prepared", o.total_prepared);
      animateValue("consumed", o.total_consumed);
      animateValue("surplus", o.total_surplus);
      animateValue("consrate", o.avg_consumption_rate_percent, "%");
    }

    // --- Renderer: Daily Trend Chart ---
    function drawDailyChart(data){
      const labels = data.map(r=>r.date);
      const values = data.map(r=>Number(r.surplus||0));
      const ctx = document.getElementById("dailyChart").getContext("2d");
      
      if(dailyChartInstance) dailyChartInstance.destroy();
      
      dailyChartInstance = new Chart(ctx, {
        type: "line",
        data: { 
          labels, 
          datasets:[{ 
            label: "Surplus Food", 
            data: values, 
            borderColor: '#ff7a20', 
            backgroundColor: 'rgba(255,122,32,0.1)', 
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 5,
            fill: true, 
            tension: 0.3 
          }]
        },
        options: { 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            y: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f3f4f6' } },
            x: { grid: { display: false } }
          } 
        }
      });
    }

    // --- Renderer: Top Dishes Bar Chart ---
    function drawDishChart(dishes){
      const labels = dishes.map(d=>d.dish_name);
      const values = dishes.map(d=>Number(d.waste_rate_percent ?? 0));
      const ctx = document.getElementById("dishChart").getContext("2d");
      
      if(dishChartInstance) dishChartInstance.destroy();
      
      dishChartInstance = new Chart(ctx, {
        type: "bar",
        data: { 
          labels, 
          datasets:[{ 
            label: "Waste Rate (%)", 
            data: values, 
            backgroundColor: '#ff7a20',
            borderRadius: 4,
            barThickness: 20
          }]
        },
        options: { 
          indexAxis: 'y', 
          responsive: true, 
          maintainAspectRatio: false,
          plugins: { legend: { display: false } }, 
          scales: { 
            x: { beginAtZero: true, grid: { borderDash: [2, 4], color: '#f3f4f6' } },
            y: { grid: { display: false } }
          } 
        }
      });
    }

    // --- Renderer: Detailed List ---
    function renderDailyTable(daily){
      const wrap = document.getElementById("tableWrap");
      
      if(!daily || !daily.length){ 
        wrap.innerHTML = '<div style="padding:20px;text-align:center;color:#6b7280">No records found.</div>'; 
        return; 
      }
      
      const rows = daily.slice().reverse().map(r => `
        <div class="data-row" onclick="rowClick('${r.date}')">
          <div>
            <div class="data-date">${r.date}</div>
            <div class="data-meta">Prep: ${r.quantity_prepared} ¬∑ Consumed: ${r.quantity_consumed}</div>
          </div>
          <div>
            <div class="data-value">${r.surplus}</div>
            <div class="data-label">Surplus</div>
          </div>
        </div>
      `).join("");
      
      wrap.innerHTML = rows;
    }

    // --- Logic: Row Click Interaction ---
    window.rowClick = function(date){
      axios.get(`${API}/threshold`, { params:{ date, threshold:0 } }).then(r=>{
        const arr = r.data || [];
        if(!arr.length){ alert("No detailed dish data for " + date); return; }
        
        const list = arr.map(a => `‚Ä¢ ${a.dish_name}: ${a.surplus} surplus`).join("\n");
        alert(`Details for ${date}:\n\n${list}`);
      }).catch(() => alert("Error fetching dish details."));
    };

    // --- Main Data Loader ---
    async function loadAndRender(){
      const loadingHTML = '<div style="padding:20px;text-align:center;color:#9ca3af">Updating dashboard...</div>';
      document.getElementById("tableWrap").innerHTML = loadingHTML;
      
      try {
        const [ov, daily, dishes] = await Promise.all([
          apiGet("/overall"), 
          apiGet("/daily"), 
          apiGet("/dishes?top=8")
        ]);

        renderOverview(ov);
        drawDailyChart(daily.slice(-60)); // Last 60 days
        drawDishChart(dishes);
        renderDailyTable(daily);
      } catch(e) {
        console.error(e);
        document.getElementById("tableWrap").innerHTML = 
          '<div style="padding:20px;text-align:center;color:#ef4444">Connection Error. Is the backend running?</div>';
      }
    }

    // --- Event Listeners ---
    document.getElementById("checkBtn").addEventListener("click", async () => {
      const date = document.getElementById("thresholdDate").value;
      const qty = document.getElementById("thresholdQty").value || 0;
      const resEl = document.getElementById("thresholdResult");
      
      if(!date){ 
        resEl.innerHTML = "<span style='color:#ef4444'>Please select a date first.</span>"; 
        return; 
      }
      
      resEl.innerText = "Analyzing...";
      
      try {
        const r = await axios.get(`${API}/threshold`, { params:{ date, threshold: qty }});
        const arr = r.data;
        
        if(!arr || !arr.length) {
          resEl.innerHTML = `<span style='color:#10b981'>No items exceeded ${qty} surplus on ${date}. Good job!</span>`;
        } else {
          const items = arr.map(x => `<b>${x.dish_name}</b> (${x.surplus})`).join(", ");
          resEl.innerHTML = `<span style='color:#ef4444'>High Surplus:</span> ${items}`;
        }
      } catch(e) { 
        resEl.innerText = "Error checking threshold."; 
      }
    });

    document.getElementById("refreshBtn").addEventListener("click", loadAndRender);
    
    document.getElementById("predBtn").addEventListener("click", () => {
      alert("Feature coming soon: ML-based prediction model integration.");
    });

    document.getElementById("exportBtn").addEventListener("click", async () => {
      try {
        const daily = await apiGet("/daily");
        if(!daily.length) return alert("No data to export");
        
        const keys = Object.keys(daily[0] || {});
        const csv = [keys.join(",")].concat(
          daily.map(r => keys.map(k => JSON.stringify(r[k] ?? "")).join(","))
        ).join("\n");
        
        const blob = new Blob([csv], { type:'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); 
        a.href = url; 
        a.download = `FoodIQ_Report_${new Date().toISOString().split('T')[0]}.csv`; 
        a.click(); 
        URL.revokeObjectURL(url);
      } catch(e){ alert("Export failed"); }
    });

    // --- Initial Load ---
    loadAndRender();

  </script>
</body>
</html>
