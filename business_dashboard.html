<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FoodIQ â€” Business Performance</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #ff7a20;
      --primary-hover: #e56a00;
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --radius: 14px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 10px rgba(0,0,0,0.06);
    }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: "Inter", sans-serif; }
    .container { max-width: 1280px; margin: auto; padding: 24px; }
    .header { background: white; padding: 18px 24px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .brand-icon { width: 44px; height: 44px; background: var(--primary); border-radius: 12px; color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; }
    .brand-text h1 { margin: 0; font-size: 20px; font-weight: 700; font-family: "Poppins", sans-serif; }
    .brand-text span { font-size: 13px; color: var(--muted); }
    button.btn { padding: 9px 16px; border-radius: 8px; font-size: 13px; font-weight: 600; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(255,122,32,0.2); }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); }
    .hero-kpi { background: white; border-radius: var(--radius); border: 1px solid var(--border); padding: 28px; box-shadow: var(--shadow-md); margin-bottom: 24px; text-align: center; }
    .hero-title { font-size: 15px; color: var(--muted); letter-spacing: 0.5px; text-transform: uppercase; font-weight: 600; }
    .hero-value { font-family: "Poppins"; font-size: 46px; margin-top: 6px; font-weight: 700; color: var(--primary); }
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card { background: white; border: 1px solid var(--border); padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow-sm); }
    .kpi-label { font-size: 12px; color: var(--muted); font-weight: 600; letter-spacing: 0.04em; text-transform: uppercase; }
    .kpi-value { font-size: 26px; margin-top: 6px; font-weight: 700; font-family: "Poppins"; }
    .section-title { font-family: "Poppins"; font-size: 18px; font-weight: 600; margin-bottom: 6px; }
    .chart-card { background: white; padding: 22px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); margin-bottom: 26px; }
    .two-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 28px; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    th, td { padding: 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
    th { text-transform: uppercase; font-size: 12px; color: var(--muted); font-weight: 700; }
    .customer-scroll { display: flex; gap: 16px; overflow-x: auto; padding-bottom: 10px; }
    .customer-card { min-width: 160px; background: white; padding: 16px; border-radius: var(--radius); border: 1px solid var(--border); box-shadow: var(--shadow-sm); }
    .customer-name { font-size: 15px; font-weight: 700; font-family: "Poppins"; }
    .customer-spend { margin-top: 4px; color: var(--primary); font-weight: 600; }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="brand">
      <div class="brand-icon">ðŸ“Š</div>
      <div class="brand-text">
        <h1>Business Intelligence</h1>
        <span>Revenue & Profit Dashboard</span>
      </div>
    </div>
    <div>
      <button class="btn btn-outline" id="exportPdf">Export PDF</button>
      <button class="btn btn-primary" onclick="loadStats()">â†» Refresh</button>
    </div>
  </div>

  <div class="hero-kpi">
    <div class="hero-title">Total Revenue</div>
    <div class="hero-value" id="heroRevenue">â‚¹ --</div>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-label">Net Profit</div>
      <div class="kpi-value" id="kpiProfit">--</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Profit Margin</div>
      <div class="kpi-value" id="kpiMargin">--%</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Avg Order Value</div>
      <div class="kpi-value" id="kpiAov">--</div>
    </div>
  </div>

  <div class="chart-card">
    <div class="section-title">Revenue Over Time</div>
    <canvas id="chartRevenue"></canvas>
  </div>

  <div class="two-grid">
    <div class="chart-card">
      <div class="section-title">Profit Breakdown</div>
      <canvas id="chartProfit"></canvas>
    </div>
    <div class="chart-card">
      <div class="section-title">Category Revenue</div>
      <canvas id="chartCategory"></canvas>
    </div>
  </div>

  <div class="chart-card">
    <div class="section-title">Top Products by Profit</div>
    <table id="productTable">
      <thead>
        <tr><th>Product</th><th>Revenue</th><th>Profit</th><th>Margin</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="chart-card">
    <div class="section-title">Top Customers</div>
    <div class="customer-scroll" id="customerScroll"></div>
  </div>
</div>

<script>
async function loadStats() {
  try {
    const res = await fetch('http://127.0.0.1:5000/api/business_stats');
    if (!res.ok) throw new Error("API error");
    const data = await res.json();

    document.getElementById("heroRevenue").innerText = "â‚¹ " + (data.total_revenue || 0).toFixed(2);
    document.getElementById("kpiProfit").innerText = "â‚¹ " + (data.net_profit || 0).toFixed(2);
    document.getElementById("kpiMargin").innerText = (data.profit_margin || 0).toFixed(2) + "%";
    document.getElementById("kpiAov").innerText = "â‚¹ " + (data.avg_order_value || 0).toFixed(2);

    // revenue over time
    new Chart(document.getElementById("chartRevenue"), {
      type: "line",
      data: {
        labels: data.period_labels || [],
        datasets: [{
          label: "Revenue",
          data: data.period_values || [],
          borderColor: "#ff7a20",
          backgroundColor: "rgba(255,122,32,0.1)",
          borderWidth: 3,
          tension: 0.3,
          fill: true
        }]
      }
    });

    new Chart(document.getElementById("chartProfit"), {
      type: "bar",
      data: {
        labels: ["Revenue","Expenses","Net Profit"],
        datasets: [{ data: [data.total_revenue||0, data.total_expenses||0, data.net_profit||0],
          backgroundColor: ["#ff7a20","#9ca3af","#10b981"], borderRadius:6 }]
      }
    });

    new Chart(document.getElementById("chartCategory"), {
      type: "doughnut",
      data: {
        labels: Object.keys(data.revenue_by_category || {}),
        datasets: [{ data: Object.values(data.revenue_by_category || {}), backgroundColor: ["#ff7a20","#ff9d5c","#ffc9a5","#d26700"] }]
      }
    });

    // products table
    const tbody = document.querySelector("#productTable tbody");
    tbody.innerHTML = "";
    (data.top_products || []).forEach(item => {
      const tr = `<tr>
        <td>${item.name}</td>
        <td>â‚¹ ${Number(item.revenue||0).toFixed(2)}</td>
        <td>â‚¹ ${Number(item.profit||0).toFixed(2)}</td>
        <td>${Number(item.margin||0).toFixed(2)}%</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", tr);
    });

    // customers
    const scroll = document.getElementById("customerScroll");
    scroll.innerHTML = "";
    (data.top_customers || []).forEach(c => {
      scroll.insertAdjacentHTML("beforeend", `<div class="customer-card"><div class="customer-name">${c.name}</div><div class="customer-spend">â‚¹ ${Number(c.spend||0).toFixed(2)}</div></div>`);
    });

  } catch (err) {
    console.error(err);
    alert("Failed to load dashboard data. Check server logs and that /api/business_stats is reachable.");
  }
}

loadStats();
</script>
</body>
</html>
